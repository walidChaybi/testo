import { Droit } from "@model/agent/enum/Droit";
import { useContext, useMemo, useState } from "react";
import { ECleOngletsMiseAJour, EditionMiseAJourContext } from "../../../../contexts/EditionMiseAJourContextProvider";
import { RECEContextData } from "../../../../contexts/RECEContextProvider";
import AfficherMessage from "../../../../utils/AfficherMessage";
import Bouton from "../../../commun/bouton/Bouton";
import ConteneurModale from "../../../commun/conteneurs/modale/ConteneurModale";
import SignatureDocument from "../../../commun/signature/SignatureDocument";

interface IBoutonTerminerEtSignerProps {
  saisieMentionEnCours: boolean;
  acteEstEligibleFormuleDIntegrationEtUtilisateurALesDroits: boolean;
  nombreMentionsAjoutees: number;
}

const BoutonTerminerEtSigner: React.FC<IBoutonTerminerEtSignerProps> = ({
  saisieMentionEnCours,
  acteEstEligibleFormuleDIntegrationEtUtilisateurALesDroits,
  nombreMentionsAjoutees
}) => {
  const { utilisateurConnecte } = useContext(RECEContextData);
  const { idActe, idRequete, miseAJourEffectuee } = useContext(EditionMiseAJourContext.Valeurs);
  const { setEstActeSigne, desactiverBlocker, changerOnglet } = useContext(EditionMiseAJourContext.Actions);
  const aDroitSigner = useMemo<boolean>(
    () => utilisateurConnecte.estHabilitePour({ tousLesDroits: [Droit.SIGNER_MENTION, Droit.METTRE_A_JOUR_ACTE] }),
    [utilisateurConnecte]
  );
  const [modaleOuverte, setModaleOuverte] = useState<boolean>(false);
  
  // Pour les actes sans RECE en cours de numérisation, au moins une mention manuelle est obligatoire
  const mentionsObligatoiresManquantes = acteEstEligibleFormuleDIntegrationEtUtilisateurALesDroits && nombreMentionsAjoutees === 0;
  const boutonDesactive = saisieMentionEnCours || !miseAJourEffectuee || mentionsObligatoiresManquantes;
  const titreBouton = mentionsObligatoiresManquantes
    ? "Ajoutez au moins une mention apposée manuellement avant de signer"
    : "Terminer et signer";

  if (!aDroitSigner) return <></>;

  return (
    <>
      <Bouton
        type="button"
        title={titreBouton}
        onClick={() => {
          if (mentionsObligatoiresManquantes) {
            AfficherMessage.erreur("Au moins une mention apposée manuellement doit être ajoutée avant de pouvoir signer.", {
              fermetureAuto: true
            });
            return;
          }
          setModaleOuverte(true);
        }}
        disabled={boutonDesactive}
      >
        {"Terminer et signer"}
      </Bouton>

      {modaleOuverte && (
        <ConteneurModale>
          <div className="border-3 w-[34rem] max-w-full rounded-xl border-solid border-bleu-sombre bg-blanc p-5">
            <h2 className="m-0 mb-4 text-center font-medium text-bleu-sombre">{"Signature des mentions"}</h2>
            <SignatureDocument
              typeSignature={acteEstEligibleFormuleDIntegrationEtUtilisateurALesDroits ? "DOUBLE_NUMERIQUE" : "MISE_A_JOUR"}
              idActe={idActe}
              idRequete={idRequete}
              apresSignature={(succes: boolean) => {
                setModaleOuverte(false);
                if (!succes) return;

                changerOnglet(ECleOngletsMiseAJour.ACTE, null);
                setEstActeSigne(true);
                AfficherMessage.succes("L'acte a été mis à jour avec succès.", { fermetureAuto: true });
                desactiverBlocker();
              }}
            />
          </div>
        </ConteneurModale>
      )}
    </>
  );
};

export default BoutonTerminerEtSigner;
